
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurora Gradient Editor</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #111113; --surface: #1e1e22; --surface2: #28282d;
    --text: #f5f5f7; --text-sec: #86868b; --border: rgba(255,255,255,0.08);
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center;
    padding: 28px 20px; -webkit-font-smoothing: antialiased;
  }
  h1 { font-size: 22px; font-weight: 300; letter-spacing: -0.5px; margin-bottom: 4px; }
  .subtitle { color: var(--text-sec); font-size: 12px; margin-bottom: 24px; }

  .controls { display: flex; flex-direction: column; align-items: center; gap: 14px; margin-bottom: 20px; width: 100%; max-width: 900px; }
  .color-picker { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: center; }
  .swatch {
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    border: 3px solid transparent; transition: all 0.2s; position: relative;
  }
  .swatch:hover { transform: scale(1.1); }
  .swatch.active { border-color: #fff; box-shadow: 0 0 12px rgba(255,255,255,0.1); transform: scale(1.12); }
  .swatch .tip, .icon-btn .tip, .cc-wrap .tip {
    position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%);
    font-size: 9px; color: var(--text-sec); white-space: nowrap; opacity: 0; transition: opacity 0.15s; pointer-events: none;
  }
  .swatch.active .tip, .swatch:hover .tip, .icon-btn:hover .tip, .cc-wrap:hover .tip { opacity: 1; }
  .divider { width: 1px; height: 22px; background: var(--border); margin: 0 2px; }
  .icon-btn {
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    border: 3px solid transparent; transition: all 0.2s; position: relative;
    background: var(--surface); display: flex; align-items: center; justify-content: center;
    font-size: 14px; color: var(--text-sec);
  }
  .icon-btn:hover { transform: scale(1.1); color: var(--text); }
  .cc-input {
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    border: 3px solid transparent; transition: all 0.2s; padding: 0;
    overflow: hidden; background: transparent; -webkit-appearance: none;
  }
  .cc-input::-webkit-color-swatch-wrapper { padding: 0; }
  .cc-input::-webkit-color-swatch { border: none; border-radius: 50%; }
  .cc-input:hover { transform: scale(1.1); }
  .cc-input.active { border-color: #fff; box-shadow: 0 0 12px rgba(255,255,255,0.1); transform: scale(1.12); }
  .cc-wrap { position: relative; }

  .row { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; align-items: center; }
  .sl { display: flex; align-items: center; gap: 6px; }
  .sl label { font-size: 11px; color: var(--text-sec); min-width: 50px; }
  .sl input[type="range"] { width: 100px; accent-color: #555; }
  .sl .v { font-size: 10px; font-family: 'SF Mono', monospace; color: var(--text-sec); min-width: 32px; text-align: right; }
  .toggle { display: flex; background: var(--surface); border-radius: 7px; overflow: hidden; border: 1px solid var(--border); }
  .tbtn {
    padding: 5px 14px; font-size: 11px; font-weight: 500; cursor: pointer;
    background: transparent; color: var(--text-sec); border: none; font-family: inherit; transition: all 0.15s;
  }
  .tbtn.active { background: rgba(255,255,255,0.1); color: var(--text); }

  .editor { width: 100%; max-width: 900px; display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
  .canvas-wrap {
    flex: 1; min-width: 340px; max-width: 540px; position: relative;
    aspect-ratio: 16/10; border-radius: 16px; overflow: hidden;
    box-shadow: 0 4px 30px rgba(0,0,0,0.5); cursor: crosshair;
  }
  .canvas-wrap canvas { width: 100%; height: 100%; display: block; pointer-events: none; }
  .canvas-label { position: absolute; bottom: 12px; left: 16px; font-size: 11px; font-weight: 500; pointer-events: none; }
  .canvas-label.dk { color: rgba(255,255,255,0.3); }
  .canvas-label.lt { color: rgba(0,0,0,0.2); }
  .handle {
    position: absolute; width: 18px; height: 18px; border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.8); cursor: grab; transform: translate(-50%,-50%);
    transition: box-shadow 0.15s; z-index: 10;
  }
  .handle:hover, .handle.dragging { box-shadow: 0 0 12px rgba(255,255,255,0.4); cursor: grabbing; }
  .handle .hlabel {
    position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
    font-size: 8px; color: rgba(255,255,255,0.7); white-space: nowrap;
    pointer-events: none; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }
  .add-blob-hint { position: absolute; top: 10px; right: 12px; font-size: 10px; color: rgba(255,255,255,0.3); pointer-events: none; }

  .blob-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; width: 100%; max-width: 900px; justify-content: center; }
  .blob-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 12px 14px; min-width: 200px; flex: 1; max-width: 280px;
  }
  .blob-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  .blob-header .dot { width: 18px; height: 18px; border-radius: 6px; flex-shrink: 0; }
  .blob-header .bname { font-size: 12px; font-weight: 600; flex: 1; }
  .blob-header .bhex { font-size: 10px; font-family: 'SF Mono', monospace; color: var(--text-sec); }
  .blob-header .rm {
    cursor: pointer; color: #ff453a; font-weight: bold; font-size: 14px; line-height: 1;
    margin-left: 4px; padding: 2px 4px; border-radius: 4px; transition: background 0.15s;
  }
  .blob-header .rm:hover { background: rgba(255,69,58,0.15); }
  .blob-sl { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .blob-sl label { font-size: 10px; color: var(--text-sec); min-width: 52px; }
  .blob-sl input[type="range"] { flex: 1; height: 4px; accent-color: #555; }
  .blob-sl .bv { font-size: 9px; font-family: 'SF Mono', monospace; color: var(--text-sec); min-width: 34px; text-align: right; }

  .presets-bar {
    display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center;
    margin-top: 16px; width: 100%; max-width: 900px;
  }
  .preset-chip {
    padding: 5px 12px; font-size: 11px; font-weight: 500; cursor: pointer;
    background: var(--surface); color: var(--text-sec); border: 1px solid var(--border);
    border-radius: 8px; font-family: inherit; transition: all 0.15s; display: flex; align-items: center; gap: 6px;
  }
  .preset-chip:hover { background: rgba(255,255,255,0.06); color: var(--text); }
  .preset-chip.active { border-color: rgba(255,255,255,0.25); color: var(--text); }
  .preset-chip .pdel { color: #ff453a; font-size: 12px; cursor: pointer; margin-left: 2px; }
  .preset-chip .pdel:hover { color: #ff6961; }
  .save-input {
    padding: 5px 10px; font-size: 11px; background: var(--surface); color: var(--text);
    border: 1px solid var(--border); border-radius: 8px; font-family: inherit; width: 130px; outline: none;
  }
  .save-input:focus { border-color: rgba(255,255,255,0.25); }
  .save-btn, .preview-btn {
    padding: 5px 14px; font-size: 11px; font-weight: 600; cursor: pointer;
    background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid var(--border);
    border-radius: 8px; font-family: inherit; transition: all 0.15s;
  }
  .save-btn:hover, .preview-btn:hover { background: rgba(255,255,255,0.14); }
  .presets-label { font-size: 10px; color: var(--text-sec); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

  .export-panel {
    margin-top: 20px; width: 100%; max-width: 900px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px;
  }
  .export-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .export-header-left { display: flex; align-items: center; gap: 10px; }
  .tab-row { display: flex; gap: 0; }
  .tab {
    padding: 5px 16px; font-size: 11px; font-weight: 500; cursor: pointer;
    background: transparent; color: var(--text-sec); border: 1px solid var(--border);
    border-bottom: none; font-family: inherit; transition: all 0.15s;
  }
  .tab:first-child { border-radius: 7px 0 0 0; }
  .tab:last-child { border-radius: 0 7px 0 0; }
  .tab.active { background: #0d0d0f; color: var(--text); }
  .ebtn {
    padding: 5px 14px; font-size: 11px; font-weight: 500; cursor: pointer;
    background: var(--surface2); color: var(--text-sec); border: 1px solid var(--border);
    border-radius: 7px; font-family: inherit; transition: all 0.15s;
  }
  .ebtn:hover { background: rgba(255,255,255,0.08); color: var(--text); }
  .ebtn.copied { background: #1a472a; color: #34c759; border-color: #34c759; }
  .code-block {
    background: #0d0d0f; border: 1px solid var(--border); border-radius: 10px;
    padding: 14px; font-family: 'SF Mono', Menlo, monospace; font-size: 11px;
    line-height: 1.6; color: #c8c8cc; overflow-x: auto; white-space: pre;
    max-height: 360px; overflow-y: auto;
    user-select: text; -webkit-user-select: text; cursor: text;
  }

  /* About */
  .about {
    margin-top: 28px; width: 100%; max-width: 900px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px 24px;
    font-size: 12px; line-height: 1.7; color: var(--text-sec);
  }
  .about h3 { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 10px; }
  .about strong { color: var(--text); font-weight: 500; }
  .about p { margin-bottom: 8px; }
  .about code { background: rgba(255,255,255,0.05); padding: 1px 5px; border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 11px; }

  /* Full-window preview overlay */
  .preview-overlay {
    display: none; position: fixed; inset: 0; z-index: 1000;
    flex-direction: column; align-items: center; justify-content: center;
  }
  .preview-overlay.visible { display: flex; }
  .preview-overlay canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
  .preview-bar {
    position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 8px; z-index: 10;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
  }
  .preview-bar .tbtn { color: rgba(255,255,255,0.6); }
  .preview-bar .tbtn.active { background: rgba(255,255,255,0.15); color: #fff; }
  .preview-close {
    position: absolute; top: 20px; right: 24px; z-index: 10;
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.7); font-size: 18px; transition: all 0.15s;
  }
  .preview-close:hover { background: rgba(0,0,0,0.6); color: #fff; }
</style>
</head>
<body>

<h1>Aurora Gradient Editor</h1>
<p class="subtitle">Drag blobs Â· Double-click to add Â· Save presets Â· Full-window preview</p>

<div class="controls">
  <div class="color-picker" id="colorPicker"></div>
  <div class="row">
    <div class="toggle">
      <button class="tbtn active" data-m="both">Both</button>
      <button class="tbtn" data-m="dark">Dark</button>
      <button class="tbtn" data-m="light">Light</button>
    </div>
    <div class="sl">
      <label>Spread</label>
      <input type="range" id="sSpread" min="5" max="90" step="1" value="30">
      <span class="v" id="vSpread">30Â°</span>
    </div>
    <div class="sl">
      <label>Glow â˜¾</label>
      <input type="range" id="sGlowDark" min="0.3" max="2.5" step="0.05" value="1.0">
      <span class="v" id="vGlowDark">1.00</span>
    </div>
    <div class="sl">
      <label>Glow â˜€</label>
      <input type="range" id="sGlowLight" min="0.1" max="2.0" step="0.05" value="0.60">
      <span class="v" id="vGlowLight">0.60</span>
    </div>
    <div class="sl">
      <label>Radius</label>
      <input type="range" id="sRadius" min="0.1" max="0.8" step="0.01" value="0.40">
      <span class="v" id="vRadius">0.40</span>
    </div>
    <button class="preview-btn" id="previewBtn">â›¶ Preview</button>
  </div>
</div>

<div class="editor">
  <div class="canvas-wrap" id="darkWrap">
    <canvas id="darkCanvas"></canvas>
    <div class="canvas-label dk">Dark</div>
    <div class="add-blob-hint">double-click to add blob</div>
  </div>
  <div class="canvas-wrap" id="lightWrap">
    <canvas id="lightCanvas"></canvas>
    <div class="canvas-label lt">Light</div>
  </div>
</div>

<div class="blob-list" id="blobList"></div>

<div class="presets-bar" id="presetsBar">
  <span class="presets-label">Presets</span>
  <input type="text" class="save-input" id="presetNameInput" placeholder="Preset nameâ€¦">
  <button class="save-btn" id="savePresetBtn">Save</button>
</div>

<div class="export-panel">
  <div class="export-header">
    <div class="export-header-left">
      <div class="tab-row">
        <button class="tab active" data-tab="css">CSS</button>
        <button class="tab" data-tab="swift">AuroraConfig.swift</button>
        <button class="tab" data-tab="oklch">Oklch Data</button>
      </div>
    </div>
    <button class="ebtn" id="copyBtn">Copy</button>
  </div>
  <div class="code-block" id="codeBlock"></div>
</div>

<div class="about">
  <h3>About</h3>
  <p>Aurora Gradient Editor creates <strong>app background gradients</strong> using gaussian color blobs positioned on a canvas. All colors are computed from a single <strong>base accent color</strong> using the <strong>Oklch</strong> perceptually uniform color space.</p>
  <p><strong>How it works:</strong> Each blob stores a recipe â€” hue shift, chroma multiplier, lightness multiplier, and size â€” relative to the base color. When you switch the base color (e.g. from Blue to Green), all blobs recompute their absolute colors while preserving the same visual harmony.</p>
  <p><strong>Dark vs Light mode:</strong> The same recipes produce different lightness ranges per mode. <code>Glow â˜¾</code> and <code>Glow â˜€</code> control chroma intensity independently â€” light backgrounds need less chroma to look equally vivid.</p>
  <p><strong>Oklch math:</strong> <code>L = isDark ? (0.10 + lMul Ã— 0.28) : (0.82 + lMul Ã— 0.13)</code>, <code>C = baseChroma Ã— cMul Ã— glow</code>, <code>H = baseHue + hueShift</code>. Oklch guarantees equal Î”L = equal perceived brightness change regardless of hue.</p>
  <p><strong>Export:</strong> CSS uses <code>oklch()</code> with <code>calc(var(--aurora-hue) + shift)</code> â€” change one variable to recolor. SwiftUI export generates <code>AuroraConfig.swift</code> with blob recipes that resolve at runtime from <code>baseHue</code> + <code>colorScheme</code>.</p>
</div>

<!-- Full-window preview overlay -->
<div class="preview-overlay" id="previewOverlay">
  <canvas id="previewCanvas"></canvas>
  <div class="preview-bar">
    <button class="tbtn active" data-pm="dark">Dark</button>
    <button class="tbtn" data-pm="light">Light</button>
  </div>
  <div class="preview-close" id="previewClose">âœ•</div>
</div>

<script>
const cl=v=>Math.min(1,Math.max(0,v));

function oklchToRgb(L,C,h){
  const hr=h*Math.PI/180,a=C*Math.cos(hr),b=C*Math.sin(hr);
  const l_=L+0.3963377774*a+0.2158037573*b,m_=L-0.1055613458*a-0.0638541728*b,s_=L-0.0894841775*a-1.2914855480*b;
  const l=l_*l_*l_,m=m_*m_*m_,s=s_*s_*s_;
  const ts=c=>c<=0.0031308?12.92*c:1.055*Math.pow(c,1/2.4)-0.055;
  return[Math.round(cl(ts(4.0767416621*l-3.3077115913*m+0.2309699292*s))*255),Math.round(cl(ts(-1.2684380046*l+2.6097574011*m-0.3413193965*s))*255),Math.round(cl(ts(-0.0041960863*l-0.7034186147*m+1.7076147010*s))*255)];
}

function hexToOklch(hex){
  const tl=c=>c<=0.04045?c/12.92:Math.pow((c+0.055)/1.055,2.4);
  const r=tl(parseInt(hex.slice(1,3),16)/255),g=tl(parseInt(hex.slice(3,5),16)/255),b=tl(parseInt(hex.slice(5,7),16)/255);
  const l=0.4122214708*r+0.5363325363*g+0.0514459929*b,m=0.2119034982*r+0.6806995451*g+0.1073969566*b,s=0.0883024619*r+0.2817188376*g+0.6299787005*b;
  const l_=Math.cbrt(l),m_=Math.cbrt(m),s_=Math.cbrt(s);
  const L=0.2104542553*l_+0.7936177850*m_-0.0040720468*s_,A=1.9779984951*l_-2.4285922050*m_+0.4505937099*s_,B=0.0259040371*l_+0.7827717662*m_-0.8086757660*s_;
  let h=Math.atan2(B,A)*180/Math.PI;if(h<0)h+=360;
  return{l:L,c:Math.sqrt(A*A+B*B),h};
}

const toHex=(r,g,b)=>'#'+[r,g,b].map(c=>c.toString(16).padStart(2,'0')).join('');
function randomHex(){const h=Math.random()*360,c=0.1+Math.random()*0.12,l=0.45+Math.random()*0.3;const[r,g,b]=oklchToRgb(l,c,h);return toHex(r,g,b);}

const APPLE=[
  {name:'Blue',h:258,c:0.155,l:0.55,srgb:'#007AFF'},{name:'Purple',h:303,c:0.155,l:0.44,srgb:'#5856D6'},
  {name:'Pink',h:350,c:0.17,l:0.60,srgb:'#FF2D55'},{name:'Red',h:25,c:0.18,l:0.52,srgb:'#FF3B30'},
  {name:'Orange',h:45,c:0.17,l:0.65,srgb:'#FF9500'},{name:'Yellow',h:85,c:0.15,l:0.82,srgb:'#FFCC00'},
  {name:'Green',h:150,c:0.15,l:0.60,srgb:'#34C759'},{name:'Gray',h:0,c:0.0,l:0.55,srgb:'#8E8E93'},
];

let selColor=0,customOk=null;
let mode='both',spread=30,glowDark=1.0,glowLight=0.60,radius=0.40;
let activeTab='css';
let blobs=[
  {cx:0.28,cy:0.38,dH:0,cMul:1.0,rMul:1.15,lMul:1.0,name:'Primary'},
  {cx:0.72,cy:0.52,dH:30,cMul:0.75,rMul:1.0,lMul:0.85,name:'Shift'},
  {cx:0.50,cy:0.78,dH:-18,cMul:0.40,rMul:0.75,lMul:0.65,name:'Echo'},
];
let blobCounter=3,cardsBlobCount=-1;

function getBase(){
  if(selColor===-1&&customOk)return{h:customOk.h,c:customOk.c,l:customOk.l};
  return{h:APPLE[selColor].h,c:APPLE[selColor].c,l:APPLE[selColor].l};
}

function resolveBlobs(isDark){
  const base=getBase(),g=isDark?glowDark:glowLight;
  return blobs.map(b=>{
    const h=((base.h+b.dH)%360+360)%360;
    const c=Math.min(0.37,Math.max(0,base.c*b.cMul*g));
    const l=isDark?(0.10+b.lMul*0.28):(0.82+b.lMul*0.13);
    const r=radius*b.rMul;
    const[rr,gg,bb]=oklchToRgb(l,c,h);
    return{...b,h,c,l,r,rgb:[rr,gg,bb],hex:toHex(rr,gg,bb)};
  });
}

function renderAurora(canvas,resolved,isDark){
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.getBoundingClientRect();
  const w=Math.round(rect.width*dpr),h=Math.round(rect.height*dpr);
  canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext('2d'),img=ctx.createImageData(w,h),d=img.data;
  const bgR=isDark?14:245,bgG=isDark?14:245,bgB=isDark?18:247;
  const bd=resolved.map(b=>({cx:b.cx*w,cy:b.cy*h,isX:1/(2*(b.r*w)**2),isY:1/(2*(b.r*h)**2),dr:b.rgb[0]-bgR,dg:b.rgb[1]-bgG,db:b.rgb[2]-bgB}));
  const mul=isDark?1.0:0.55;
  for(let py=0;py<h;py++)for(let px=0;px<w;px++){
    let rA=bgR,gA=bgG,bA=bgB;
    for(const b of bd){const dx=px-b.cx,dy=py-b.cy;const f=Math.exp(-(dx*dx*b.isX+dy*dy*b.isY))*mul;rA+=b.dr*f;gA+=b.dg*f;bA+=b.db*f;}
    const i=(py*w+px)*4;d[i]=Math.min(255,Math.max(0,Math.round(rA)));d[i+1]=Math.min(255,Math.max(0,Math.round(gA)));d[i+2]=Math.min(255,Math.max(0,Math.round(bA)));d[i+3]=255;
  }
  ctx.putImageData(img,0,0);
}

function renderVisuals(){
  const darkR=resolveBlobs(true),lightR=resolveBlobs(false);
  document.getElementById('darkWrap').style.display=mode==='light'?'none':'';
  document.getElementById('lightWrap').style.display=mode==='dark'?'none':'';
  if(mode!=='light')renderAurora(document.getElementById('darkCanvas'),darkR,true);
  if(mode!=='dark')renderAurora(document.getElementById('lightCanvas'),lightR,false);
  renderHandles(darkR);
  updateBlobCardColors(darkR);
  renderExport();
}

function renderFull(){cardsBlobCount=-1;buildBlobCards();renderVisuals();}

// Handles
let dragIdx=-1;
function renderHandles(resolved){
  const wrap=document.getElementById('darkWrap');
  wrap.querySelectorAll('.handle').forEach(h=>h.remove());
  if(mode==='light')return;
  resolved.forEach((b,i)=>{
    const h=document.createElement('div');h.className='handle';h.style.left=(b.cx*100)+'%';h.style.top=(b.cy*100)+'%';h.style.background=b.hex;
    h.innerHTML=`<span class="hlabel">${b.name}</span>`;
    h.addEventListener('mousedown',e=>{e.stopPropagation();dragIdx=i;h.classList.add('dragging');});
    h.addEventListener('touchstart',e=>{e.stopPropagation();e.preventDefault();dragIdx=i;h.classList.add('dragging');},{passive:false});
    wrap.appendChild(h);
  });
}
function handleMove(cx,cy){if(dragIdx<0)return;const rect=document.getElementById('darkWrap').getBoundingClientRect();blobs[dragIdx].cx=Math.min(1,Math.max(0,(cx-rect.left)/rect.width));blobs[dragIdx].cy=Math.min(1,Math.max(0,(cy-rect.top)/rect.height));renderVisuals();}
function handleEnd(){if(dragIdx>=0){document.querySelectorAll('.handle').forEach(h=>h.classList.remove('dragging'));dragIdx=-1;}}
document.addEventListener('mousemove',e=>handleMove(e.clientX,e.clientY));
document.addEventListener('mouseup',handleEnd);
document.addEventListener('touchmove',e=>{if(dragIdx>=0){e.preventDefault();handleMove(e.touches[0].clientX,e.touches[0].clientY);}},{passive:false});
document.addEventListener('touchend',handleEnd);

document.getElementById('darkWrap').addEventListener('dblclick',e=>{
  const rect=e.currentTarget.getBoundingClientRect();blobCounter++;
  blobs.push({cx:(e.clientX-rect.left)/rect.width,cy:(e.clientY-rect.top)/rect.height,dH:Math.round((Math.random()-0.5)*spread*2),cMul:0.4+Math.random()*0.6,rMul:0.5+Math.random()*0.5,lMul:0.5+Math.random()*0.5,name:'Blob '+blobCounter});
  renderFull();
});

// Blob cards
function buildBlobCards(){
  if(cardsBlobCount===blobs.length)return;
  cardsBlobCount=blobs.length;
  const list=document.getElementById('blobList');list.innerHTML='';
  blobs.forEach((_,i)=>{
    const card=document.createElement('div');card.className='blob-card';card.dataset.idx=i;
    const header=document.createElement('div');header.className='blob-header';
    header.innerHTML=`<div class="dot" data-role="dot"></div><span class="bname">${blobs[i].name}</span><span class="bhex" data-role="hex"></span><span class="rm" data-i="${i}">âœ•</span>`;
    card.appendChild(header);
    [{label:'Lightness',prop:'lMul',min:0.05,max:1.5,step:0.05,fmt:v=>v.toFixed(2)},{label:'Chroma',prop:'cMul',min:0.05,max:2.0,step:0.05,fmt:v=>v.toFixed(2)},{label:'Hue shift',prop:'dH',min:-180,max:180,step:1,fmt:v=>(v>=0?'+':'')+v+'Â°'},{label:'Size',prop:'rMul',min:0.2,max:2.0,step:0.05,fmt:v=>v.toFixed(2)}].forEach(s=>{
      const row=document.createElement('div');row.className='blob-sl';
      const lbl=document.createElement('label');lbl.textContent=s.label;
      const inp=document.createElement('input');inp.type='range';inp.min=s.min;inp.max=s.max;inp.step=s.step;inp.value=blobs[i][s.prop];
      const vSpan=document.createElement('span');vSpan.className='bv';vSpan.textContent=s.fmt(blobs[i][s.prop]);
      inp.addEventListener('input',()=>{const v=parseFloat(inp.value);blobs[i][s.prop]=v;vSpan.textContent=s.fmt(v);renderVisuals();});
      row.appendChild(lbl);row.appendChild(inp);row.appendChild(vSpan);card.appendChild(row);
    });
    list.appendChild(card);
  });
  list.querySelectorAll('.rm').forEach(rm=>rm.addEventListener('click',()=>{const i=parseInt(rm.dataset.i);if(blobs.length>1){blobs.splice(i,1);renderFull();}}));
}

function updateBlobCardColors(resolved){
  document.querySelectorAll('.blob-card').forEach((card,i)=>{
    if(!resolved[i])return;
    const dot=card.querySelector('[data-role="dot"]'),hex=card.querySelector('[data-role="hex"]');
    if(dot)dot.style.background=resolved[i].hex;if(hex)hex.textContent=resolved[i].hex;
  });
}

// Presets
const STORAGE_KEY='aurora-gradient-presets';
function getPresets(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];}catch{return[];}}
function savePresets(p){localStorage.setItem(STORAGE_KEY,JSON.stringify(p));}
function getCurrentState(){return{selColor,customOk,spread,glowDark,glowLight,radius,blobs:JSON.parse(JSON.stringify(blobs)),blobCounter};}
function applyState(st){
  selColor=st.selColor??0;customOk=st.customOk??null;spread=st.spread??30;glowDark=st.glowDark??1.0;glowLight=st.glowLight??0.60;radius=st.radius??0.40;blobs=st.blobs||[];blobCounter=st.blobCounter||blobs.length;
  document.getElementById('sSpread').value=spread;document.getElementById('vSpread').textContent=spread+'Â°';
  document.getElementById('sGlowDark').value=glowDark;document.getElementById('vGlowDark').textContent=glowDark.toFixed(2);
  document.getElementById('sGlowLight').value=glowLight;document.getElementById('vGlowLight').textContent=glowLight.toFixed(2);
  document.getElementById('sRadius').value=radius;document.getElementById('vRadius').textContent=radius.toFixed(2);
  if(customOk){const ci=document.getElementById('ccInput');if(ci)ci.value=customOk.srgb||'#6a5acd';}
  updActive();renderFull();
}
function renderPresets(){
  const bar=document.getElementById('presetsBar');bar.querySelectorAll('.preset-chip').forEach(c=>c.remove());
  getPresets().forEach((p,i)=>{
    const chip=document.createElement('button');chip.className='preset-chip';
    chip.innerHTML=`${p.name}<span class="pdel" data-pi="${i}">âœ•</span>`;
    chip.addEventListener('click',e=>{if(e.target.classList.contains('pdel'))return;applyState(p.state);bar.querySelectorAll('.preset-chip').forEach(c=>c.classList.remove('active'));chip.classList.add('active');});
    bar.appendChild(chip);
  });
  bar.querySelectorAll('.pdel').forEach(d=>d.addEventListener('click',e=>{e.stopPropagation();const presets=getPresets();presets.splice(parseInt(d.dataset.pi),1);savePresets(presets);renderPresets();}));
}
document.getElementById('savePresetBtn').addEventListener('click',()=>{
  const ni=document.getElementById('presetNameInput'),name=ni.value.trim()||('Preset '+(getPresets().length+1));
  const presets=getPresets();presets.push({name,state:getCurrentState()});savePresets(presets);ni.value='';renderPresets();
});

// ============================================================
// Export â€” clean, no comments
// ============================================================
function generateCSS(){
  const base=getBase();
  let css=`:root {\n  --aurora-hue: ${Math.round(base.h)};\n  --aurora-chroma: ${base.c.toFixed(3)};\n}\n\n`;
  css+=`.aurora-dark {\n  background:\n`;
  blobs.forEach((b,i)=>{
    const hExpr=b.dH===0?`var(--aurora-hue)`:`calc(var(--aurora-hue) + ${b.dH})`;
    const cVal=(b.cMul*glowDark*base.c).toFixed(3);
    const lVal=(0.10+b.lMul*0.28).toFixed(2);
    const sz=Math.round(radius*b.rMul*200);
    const px=(b.cx*100).toFixed(1),py=(b.cy*100).toFixed(1);
    css+=`    radial-gradient(ellipse ${sz}% ${sz}% at ${px}% ${py}%, oklch(${lVal} ${cVal} ${hExpr}) 0%, transparent 70%)${i<blobs.length-1?',':''}\n`;
  });
  css+=`    , #0e0e12;\n}\n\n`;
  css+=`.aurora-light {\n  background:\n`;
  blobs.forEach((b,i)=>{
    const hExpr=b.dH===0?`var(--aurora-hue)`:`calc(var(--aurora-hue) + ${b.dH})`;
    const cVal=(b.cMul*glowLight*base.c).toFixed(3);
    const lVal=(0.82+b.lMul*0.13).toFixed(2);
    const sz=Math.round(radius*b.rMul*200);
    const px=(b.cx*100).toFixed(1),py=(b.cy*100).toFixed(1);
    css+=`    radial-gradient(ellipse ${sz}% ${sz}% at ${px}% ${py}%, oklch(${lVal} ${cVal} ${hExpr}) 0%, transparent 70%)${i<blobs.length-1?',':''}\n`;
  });
  css+=`    , #f5f5f7;\n}\n`;
  return css;
}

function generateSwift(){
  let s=`struct AuroraConfig {\n`;
  s+=`    static let glowDark: Double = ${glowDark.toFixed(2)}\n`;
  s+=`    static let glowLight: Double = ${glowLight.toFixed(2)}\n`;
  s+=`    static let baseRadius: Double = ${radius.toFixed(2)}\n\n`;
  s+=`    static let recipes: [AuroraBlobRecipe] = [\n`;
  blobs.forEach(b=>{
    s+=`        AuroraBlobRecipe(cx: ${b.cx.toFixed(3)}, cy: ${b.cy.toFixed(3)}, hueShift: ${b.dH.toFixed(1)}, chromaMul: ${b.cMul.toFixed(2)}, lightMul: ${b.lMul.toFixed(2)}, sizeMul: ${b.rMul.toFixed(2)}),\n`;
  });
  s+=`    ]\n}\n`;
  return s;
}

function generateOklchData(){
  const base=getBase(),darkR=resolveBlobs(true);
  let s=`const config = {\n  baseHue: ${base.h.toFixed(0)}, baseChroma: ${base.c.toFixed(3)},\n`;
  s+=`  glowDark: ${glowDark.toFixed(2)}, glowLight: ${glowLight.toFixed(2)}, radius: ${radius.toFixed(2)},\n};\n\n`;
  s+=`const recipes = [\n`;
  blobs.forEach(b=>{s+=`  { cx:${b.cx.toFixed(3)}, cy:${b.cy.toFixed(3)}, dH:${b.dH}, cMul:${b.cMul.toFixed(2)}, lMul:${b.lMul.toFixed(2)}, rMul:${b.rMul.toFixed(2)} },\n`;});
  s+=`];\n\nfunction resolve(r, isDark) {\n  const g = isDark ? config.glowDark : config.glowLight;\n`;
  s+=`  return {\n    h: (config.baseHue + r.dH + 360) % 360,\n    c: Math.min(0.37, config.baseChroma * r.cMul * g),\n`;
  s+=`    l: isDark ? (0.10 + r.lMul * 0.28) : (0.82 + r.lMul * 0.13),\n    r: config.radius * r.rMul, cx: r.cx, cy: r.cy,\n  };\n}\n`;
  return s;
}

function renderExport(){
  const block=document.getElementById('codeBlock');
  if(activeTab==='css')block.textContent=generateCSS();
  else if(activeTab==='swift')block.textContent=generateSwift();
  else block.textContent=generateOklchData();
}

// ============================================================
// Full-window preview
// ============================================================
let previewMode='dark';

function openPreview(){
  document.getElementById('previewOverlay').classList.add('visible');
  document.body.style.overflow='hidden';
  renderPreview();
}

function closePreview(){
  document.getElementById('previewOverlay').classList.remove('visible');
  document.body.style.overflow='';
}

function renderPreview(){
  const overlay=document.getElementById('previewOverlay');
  if(!overlay.classList.contains('visible'))return;
  const resolved=resolveBlobs(previewMode==='dark');
  renderAurora(document.getElementById('previewCanvas'),resolved,previewMode==='dark');
}

document.getElementById('previewBtn').addEventListener('click',openPreview);
document.getElementById('previewClose').addEventListener('click',closePreview);
document.addEventListener('keydown',e=>{if(e.key==='Escape')closePreview();});

document.querySelectorAll('[data-pm]').forEach(btn=>btn.addEventListener('click',()=>{
  document.querySelectorAll('[data-pm]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');previewMode=btn.dataset.pm;renderPreview();
}));

// ============================================================
// UI wiring
// ============================================================
function buildPicker(){
  const pk=document.getElementById('colorPicker');pk.innerHTML='';
  APPLE.forEach((c,i)=>{
    const s=document.createElement('div');s.className='swatch'+(i===selColor?' active':'');s.style.background=c.srgb;
    s.innerHTML=`<span class="tip">${c.name}</span>`;
    s.addEventListener('click',()=>{selColor=i;customOk=null;updActive();renderVisuals();renderPreview();});
    pk.appendChild(s);
  });
  pk.appendChild(Object.assign(document.createElement('div'),{className:'divider'}));
  const rb=document.createElement('div');rb.className='icon-btn';rb.id='rndBtn';rb.innerHTML='ðŸŽ²<span class="tip">Random</span>';
  rb.addEventListener('click',()=>{const h=randomHex();customOk=hexToOklch(h);customOk.srgb=h;selColor=-1;document.getElementById('ccInput').value=h;updActive();renderVisuals();renderPreview();});
  pk.appendChild(rb);
  const cw=document.createElement('div');cw.className='cc-wrap';
  const ci=document.createElement('input');ci.type='color';ci.className='cc-input';ci.id='ccInput';ci.value='#6a5acd';
  cw.innerHTML='<span class="tip">Custom</span>';cw.prepend(ci);
  ci.addEventListener('input',()=>{customOk=hexToOklch(ci.value);customOk.srgb=ci.value;selColor=-1;updActive();renderVisuals();renderPreview();});
  pk.appendChild(cw);
}

function updActive(){
  document.querySelectorAll('.swatch').forEach((s,j)=>s.classList.toggle('active',j===selColor));
  const ci=document.getElementById('ccInput');if(ci)ci.classList.toggle('active',selColor===-1);
}

document.querySelectorAll('.tbtn[data-m]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tbtn[data-m]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');mode=b.dataset.m;renderVisuals();
}));

const wire=(id,fn)=>document.getElementById(id).addEventListener('input',e=>{fn(e);renderVisuals();renderPreview();});
wire('sSpread',e=>{spread=+e.target.value;document.getElementById('vSpread').textContent=spread+'Â°';});
wire('sGlowDark',e=>{glowDark=+e.target.value;document.getElementById('vGlowDark').textContent=glowDark.toFixed(2);});
wire('sGlowLight',e=>{glowLight=+e.target.value;document.getElementById('vGlowLight').textContent=glowLight.toFixed(2);});
wire('sRadius',e=>{radius=+e.target.value;document.getElementById('vRadius').textContent=radius.toFixed(2);});

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');activeTab=t.dataset.tab;renderExport();
}));

document.getElementById('copyBtn').addEventListener('click',()=>{
  const text=document.getElementById('codeBlock').textContent;
  navigator.clipboard.writeText(text).then(()=>{const btn=document.getElementById('copyBtn');btn.classList.add('copied');btn.textContent='Copied!';setTimeout(()=>{btn.classList.remove('copied');btn.textContent='Copy';},1500);});
});

window.addEventListener('resize',()=>{renderVisuals();renderPreview();});

buildPicker();renderPresets();renderFull();
</script>
</body>
</html>
